<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelir Gider Takibi</title>

    <!-- PWA: Dynamic Manifest -->
    <link rel="manifest" href="/manifest.json">
    <!-- Android / Chrome Theme -->
    <meta name="theme-color" content="#ffffff">
    <!-- iPhone / Safari Support -->
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Muhasebe API">
    <!-- Favicon -->
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">
    <!-- Service Worker (optional but recommended) -->
    <!--
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/sw.js').catch(err => {
                    console.log('SW register failed: ', err);
                });
            }
        </script>
    -->

    <!-- jsPDF ve AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- ExcelJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <style>
        body {
            font-family: "Segoe UI", Arial; /* Diğer sayfalarla uyumlu font */
            background: #f4f8fb; /* Diğer sayfalarla uyumlu düz arka plan */
            margin: 0;
            padding: 20px;
            max-width: 900px;
            margin: auto;
            color: #2c3e50;
        }

        .main-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            letter-spacing: 0.5px;
        }

        .main-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .left-panel, .right-panel {
            flex: 1;
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.3s ease;
        }
        .left-panel, .right-panel {
            width: 48%;
        }


            .left-panel:hover, .right-panel:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 24px rgba(0,0,0,0.1);
            }

            .left-panel h3, .right-panel h3 {
                text-align: center;
                margin-bottom: 20px;
                color: #34495e;
                font-size: 18px;
                border-bottom: 2px solid #3498db;
                padding-bottom: 6px;
            }

            .left-panel input, .left-panel select,
            .right-panel input, .right-panel select {
                width: 100%;
                padding: 10px 12px;
                margin-bottom: 12px;
                border: 1px solid #ccc;
                border-radius: 8px;
                transition: border-color 0.2s;
                font-size: 14px;
            }

                .left-panel input:focus, .left-panel select:focus,
                .right-panel input:focus, .right-panel select:focus {
                    border-color: #3498db;
                    outline: none;
                }

        .btn-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

            .btn-container button {
                flex: 1;
                padding: 10px 12px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                color: white;
                font-weight: 500;
                font-size: 14px;
                box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            }

                .btn-container button:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 6px 10px rgba(0,0,0,0.15);
                }

        #btnEkle {
            background-color: #2ecc71;
        }

        #btnGrafik {
            background-color: #1abc9c;
        }

        #btnTarihGetir {
            background-color: #3498db;
        }

        #btnFiltreTemizle {
            background-color: #e74c3c;
        }

        #btnPdfAktar, #btnExcelAktar {
            background-color: #f39c12;
        }

        #btnKategoriler {
            background-color: #9b59b6;
        }

        #btnEkle:hover {
            background-color: #27ae60;
        }

        #btnGrafik:hover {
            background-color: #16a085;
        }

        #btnTarihGetir:hover {
            background-color: #2980b9;
        }

        #btnFiltreTemizle:hover {
            background-color: #c0392b;
        }

        #btnPdfAktar:hover, #btnExcelAktar:hover {
            background-color: #d35400;
        }

        #btnKategoriler:hover {
            background-color: #8e44ad;
        }

        .date-row, .checkbox-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            justify-content: space-between;
        }

            .checkbox-row label {
                display: flex;
                align-items: center;
                gap: 5px;
                font-size: 14px;
                color: #555;
            }

        .table-container {
            max-height: 420px;
            overflow-y: auto;
            border-radius: 12px;
            margin-top: 20px;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        th {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .gelir-row {
            background-color: #e8f5e9;
        }

        .gider-row {
            background-color: #fdecea;
        }

        .btn-duzenle, .btn-sil {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.3s;
        }

        .btn-duzenle {
            background-color: #f39c12;
            color: white;
        }

        .btn-sil {
            background-color: #e74c3c;
            color: white;
        }

        .btn-duzenle:hover {
            background-color: #d68910;
        }

        .btn-sil:hover {
            background-color: #c0392b;
        }

        .summary, .sabit-toplam {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 15px;
            margin-top: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 15px;
        }

            .sabit-toplam > div {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 10px;
                border-radius: 10px;
                width: 30%;
            }

            .sabit-toplam .gelir {
                background-color: #d4edda;
                color: #155724;
            }

            .sabit-toplam .gider {
                background-color: #f8d7da;
                color: #721c24;
            }

            .sabit-toplam .net {
                background-color: #dbe9ff;
                color: #004085;
            }

            .sabit-toplam span {
                font-weight: 700;
                margin-top: 5px;
                font-size: 16px;
            }

        #toplamKayitSayisi {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            color: #555;
        }

        /* Modal */
        #editModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

            #editModal .modal-content {
                background: white;
                padding: 25px;
                border-radius: 12px;
                width: 320px;
                box-shadow: 0 6px 20px rgba(0,0,0,0.2);
                text-align: center;
                animation: modalFadeIn 0.3s ease;
            }

            #editModal input, #editModal select {
                width: 100%;
                padding: 8px;
                margin-bottom: 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
            }

            #editModal button {
                width: 48%;
                margin: 5px 1%;
            }

        .search-container {
            flex: 1;
            display: flex;
            justify-content: flex-end;
        }

            .search-container input {
                width: 100%;
                max-width: 250px; /* buton genişliğiyle uyumlu */
                padding: 10px 12px;
                border-radius: 8px;
                border: 1px solid #ccc;
                font-size: 14px;
                box-sizing: border-box;
            }

        .left-panel input,
        .left-panel select {
            width: 100%; /* Buton genişliği ile eşit */
            max-width: 250px; /* Butonlarla aynı hizaya gelsin */
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            box-sizing: border-box;
            margin: 0 auto 12px; /* Ortaya hizalayıp alt boşluk */
            display: block;
        }
        .summary {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
            font-size: 15px;
        }

        .summary {
            display: flex;
            justify-content: space-between;
            gap: 6px; /* paneller arası boşluk azaldı */
            margin-top: 10px;
        }

            .summary > div {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 14px; /* kutular büyüdü */
                border-radius: 12px;
                width: 33%; /* kutular biraz daha geniş */
                box-sizing: border-box;
                color: #2c3e50;
                font-weight: 600;
                background: white;
                box-shadow: 0 4px 10px rgba(0,0,0,0.08);
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

                .summary > div:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
                }

            /* Renkler aynı */
            .summary .gelir {
                background-color: #d4edda;
                color: #155724;
            }

            .summary .gider {
                background-color: #f8d7da;
                color: #721c24;
            }

            .summary .net {
                background-color: #dbe9ff;
                color: #004085;
            }

            /* Yazılar biraz büyütüldü */
            .summary span {
                display: block;
                font-weight: 700;
                margin-top: 6px;
                font-size: 14px; /* biraz daha büyük */
            }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: nowrap;
        }

        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .main-title {
            flex: 1;
            margin: 0;
            text-align: center;
            font-size: clamp(16px, 4vw, 22px); /* ekran boyutuna göre esneyen yazı */
            white-space: nowrap; /* yazıyı tek satırda tut */
            overflow: hidden;
            text-overflow: ellipsis; /* çok uzarsa "…" ile kısalt */
        }

        .admin-panel-btn {
            background-color: #007bff; /* Mavi tonu */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: background-color 0.2s ease;
        }

        .admin-panel-btn:hover {
            background-color: #0056b3; /* Daha koyu mavi */
        }

        .spacer {
            width: 120px;
        }

        /* Küçük ekranlar için */
        @media (max-width: 480px) {
            .logout-btn {
                padding: 8px 14px;
                font-size: 13px;
            }

            .admin-panel-btn {
                padding: 8px 14px;
                font-size: 13px;
            }

            .spacer {
                width: 80px;
            }

            .main-title {
                font-size: 18px;
            }
        }
        .gelir-row {
            background-color: #d9fdd3 !important;
        }

        .gider-row {
            background-color: #ffd6d6 !important;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Alert Box Styles */
        .alert-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            font-size: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            z-index: 10000;
            animation: fadeInRight 0.5s ease-out;
        }

        .alert-success {
            background-color: #28a745; /* Green */
        }

        .alert-error {
            background-color: #dc3545; /* Red */
        }

        .alert-warning {
            background-color: #ffc107; /* Yellow */
            color: #343a40;
        }

        .alert-info {
            background-color: #17a2b8; /* Blue */
        }

        .close-btn {
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            line-height: 1;
            margin-left: 10px;
            opacity: 0.8;
        }

            .close-btn:hover {
                opacity: 1;
            }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .welcome-message-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            font-size: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            z-index: 10000;
            animation: fadeInRight 0.5s ease-out;
            background-color: #28a745; /* Green for success */
        }

        .welcome-message-alert.hide {
            animation: fadeOutRight 0.5s ease-in forwards; /* Kaybolma animasyonu */
        }

        @keyframes fadeOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(50px); }
        }

    </style>
</head>
<body>
    <div id="alertBox"></div>
    <div id="welcomeMessageContainer" class="alert-box alert-success" style="display: none;"></div>
    <script src="config.js"></script>

    <div class="header-bar">
        <button onclick="cikisYap()" class="logout-btn">Çıkış Yap</button>
        <h2 class="main-title">💰 Gelir Gider Takibi</h2>
        <!-- Yönetici Paneli Butonu -->
        
        <div class="spacer"></div>
    </div>


    <div class="main-container">
        <div class="left-panel">
            <h3>Kayıt Ekle</h3>
            <select id="turu" onchange="loadKategoriler()"><option value="">Tür Seçin</option><option value="Gelir">Gelir</option><option value="Gider">Gider</option></select>
            <select id="kategori"><option value="">Kategori Seçin</option></select>
            <input type="text" id="aciklama" placeholder="Açıklama zorunlu değil..." />
            <input type="number" id="tutar" placeholder="Tutar ₺" />
            <div class="btn-container" style="flex-direction: column;">
                <button id="btnEkle" onclick="addGelirGider()">➕ Ekle</button>

                <button id="btnKategoriler" onclick="window.open('kategoriler.html','_blank')">📁 Kategoriler</button>
            </div>

        </div>

        <div class="right-panel">
            <h3>Filtreleme</h3>
            <div class="date-row">
                <input type="date" id="ilkTarih">
                <input type="date" id="sonTarih">
            </div>
            <div class="btn-container">
                <button id="btnTarihGetir" onclick="filterByDate()">Tarih Aralığını Getir</button>
                <button id="btnFiltreTemizle" onclick="clearFilters()">Filtreleri Temizle</button>
            </div>
            <div class="checkbox-row">
                <label><input type="checkbox" id="gelirCheck" onchange="handleTypeCheckbox('gelir')"> Gelir</label>
                <label><input type="checkbox" id="giderCheck" onchange="handleTypeCheckbox('gider')"> Gider</label>
                <div class="search-container">
                    <input type="text" id="kategoriSearch" placeholder="Kategori ara..." oninput="handleKategoriSearch()">
                </div>
            </div>
            <div class="btn-container">
                <button id="btnPdfAktar" onclick="exportToPDF()">PDF'le Aktar</button>
                <button id="btnExcelAktar" onclick="exportFilteredToExcel()">Excel'e Aktar</button>

            </div>
            <div class="btn-container" style="flex-direction: column;">
                <button id="btnGrafik" onclick="window.open('grafik.html','_blank')">📊 Grafik</button>
            </div>
        </div>

    </div>
    <div class="sabit-toplam">
        <div class="gelir">Toplam Gelir <span id="sabitTopGelir">0 ₺</span></div>
        <div class="gider">Toplam Gider <span id="sabitTopGider">0 ₺</span></div>
        <div class="net">Net Tutar <span id="sabitNetTutar">0 ₺</span></div>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr><th>Tür</th><th>Kategori</th><th>Açıklama</th><th>Tutar</th><th>Tarih</th><th>İşlem</th></tr>
            </thead>
            <tbody id="gelirGiderBody"></tbody>
        </table>
    </div>

    <div id="toplamKayitSayisi">Toplam Kayıt: 0</div>

    <div class="summary">
        <div class="gelir">Tablodaki Gelir: <span id="topGelir">0 ₺</span></div>
        <div class="gider">Tablodaki Gider: <span id="topGider">0 ₺</span></div>
        <div class="net">Net Tutar: <span id="netTutar">0 ₺</span></div>
    </div>

    <div class="kategori-ozet-container">
        <h3>Kategoriye Göre Özet</h3>

        <div class="table-wrapper">
            <table id="dgvKategoriOzet">
                <thead>
                    <tr>
                        <th>Kategori</th>
                        <th>Kayıt Sayısı</th>
                        <th>Toplam Tutar (₺)</th>
                        <th>Tür</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Butonları yan yana getirmek için ekledim -->
        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button id="btnPdfKategori" class="pdf-button" onclick="exportKategoriOzetPDF()">📄 Kategori Özetini PDF'ye Aktar</button>
            <button id="adminPanelBtn" class="pdf-button" style="display: none; background-color: #2196F3;" onclick="window.location.href='admin.html'">Yönetici Paneli</button>
        </div>
    </div>
    <script>
        function turkceKarakterCevir(text) {
            if (!text) return '';
            const charMap = {
                'ç': 'c', 'Ç': 'C',
                'ğ': 'g', 'Ğ': 'G',
                'ı': 'i', 'İ': 'I',
                'ö': 'o', 'Ö': 'O',
                'ş': 's', 'Ş': 'S',
                'ü': 'u', 'Ü': 'U'
            };
            return text.split('').map(char => charMap[char] || char).join('');
        }

        // Custom Alert Function
        function showAlert(type, msg) {
            const alertBox = document.createElement('div');
            alertBox.className = `alert-box alert-${type}`;
            alertBox.innerHTML = `${msg} <span class="close-btn" onclick="this.parentElement.remove()">×</span>`;
            document.body.appendChild(alertBox);

            setTimeout(() => {
                alertBox.remove();
            }, 5000);
        }

        async function exportKategoriOzetPDF() {
            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) { showAlert('error', '❌ jsPDF kütüphanesi yüklenemedi!'); return; }

                // Tablodaki verileri oku
                const tbody = document.querySelector("#dgvKategoriOzet tbody");
                const domRows = Array.from(tbody.querySelectorAll('tr'));
                if (domRows.length === 0) { showAlert('warning', '⚠️ Aktarılacak veri yok!'); return; }

                const tableRows = domRows.map((row, i) => {
                    const cells = row.querySelectorAll('td');
                    return [
                        i + 1,
                        turkceKarakterCevir(cells[0].textContent.trim()), // Kategori
                        turkceKarakterCevir(cells[1].textContent.trim()), // Kayıt Sayısı
                        turkceKarakterCevir(cells[2].textContent.trim()), // Toplam Tutar
                        turkceKarakterCevir(cells[3].textContent.trim())  // Tür
                    ];
                });

                const doc = new jsPDF("p", "mm", "a4");

                // --- ÜST BİLGİ BLOĞU ---
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(0, 102, 204);
                doc.text(turkceKarakterCevir("GELİR GİDER KATEGORİ ÖZETİ"), 105, 20, { align: "center" });

                doc.setFontSize(12);
                doc.setTextColor(40, 40, 40);
                doc.text(turkceKarakterCevir("SALASH CANLI MEZAT"), 105, 28, { align: "center" });

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(80, 80, 80);
                doc.text(turkceKarakterCevir("Hocacihan Hanaybaşı, Alemdar Cd. No:107, 42080 Selçuklu/Konya"), 105, 34, { align: "center" });
                doc.text(turkceKarakterCevir("Tel: 0507 477 12 50"), 105, 40, { align: "center" });

                doc.setFontSize(8);
                doc.text(turkceKarakterCevir(`Tarih: ${new Date().toLocaleString("tr-TR")}`), 200, 46, { align: "right" });

                // --- TABLO ---
                const headers = [
                    turkceKarakterCevir('Sıra'),
                    turkceKarakterCevir('Kategori'),
                    turkceKarakterCevir('Kayıt Sayısı'),
                    turkceKarakterCevir('Toplam Tutar (TL)'),
                    turkceKarakterCevir('Tür')
                ];

                      



                doc.autoTable({
                    startY: 52,
                    head: [headers],
                    body: tableRows,
                    theme: 'grid',
                    styles: {
                        font: "helvetica",
                        fontSize: 9,
                        cellPadding: 3,
                        valign: 'middle',
                        lineWidth: 0.1,
                        lineColor: [100, 100, 100]
                    },
                    headStyles: {
                        fillColor: [120, 160, 220],
                        textColor: [255, 255, 255],
                        halign: 'center',
                        lineWidth: 0.1,
                        lineColor: [80, 80, 80]
                    },
                    didParseCell: function (data) {
                        if (data.section === 'body') {
                            const tur = data.row.raw[4]; // Tür sütunu
                            if (tur === 'Gelir') data.cell.styles.fillColor = [220, 255, 220];
                            else if (tur === 'Gider') data.cell.styles.fillColor = [255, 230, 230];
                        }
                    },
                    columnStyles: {
                        0: { cellWidth: 15, halign: 'center' },
                        1: { cellWidth: 50, halign: 'left' },
                        2: { cellWidth: 30, halign: 'center' },
                        3: { cellWidth: 35, halign: 'right' },
                        4: { cellWidth: 25, halign: 'center' }
                    },
                    tableWidth: 'wrap'
                });



                // --- TOPLAM HESAPLAMA ---
                let toplamGelir = 0, toplamGider = 0, toplamKayit = 0;
                domRows.forEach(row => {
                    // Kategori özet tablosundaki tutar sütunu 3. indexte (0-based) 
                    // ve Kayıt Sayısı 1. indexte
                    const tutarText = row.cells[2]?.textContent.trim(); 
                    const kayitSayisiText = row.cells[1]?.textContent.trim();

                    // Türkçe formatı İngilizce formata çevir: binlik ayırıcıları kaldır, ondalık virgülü noktaya çevir
                    const parsedTutar = parseFloat(tutarText.replace(/\./g, '').replace(',', '.')) || 0;
                    const parsedKayitSayisi = parseInt(kayitSayisiText) || 0;

                    toplamKayit += parsedKayitSayisi;
                    // Kategori özetinde tür sütunu 4. indexte (0-based)
                    const tur = row.cells[3]?.textContent.trim();
                    if (tur === "Gelir") toplamGelir += parsedTutar;
                    else if (tur === "Gider") toplamGider += parsedTutar;
                });
                const kalanTutar = toplamGelir - toplamGider;

                // --- PDF TABLO ALTINA TOPLAM SATIRI EKLE ---
                let finalY = doc.lastAutoTable.finalY + 10;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.setTextColor(30, 30, 30);



                doc.setFontSize(10);
                doc.text(turkceKarakterCevir(`Toplam Gelir: ${toplamGelir.toFixed(2).replace('.', ',')} TL`), 20, finalY + 10);
                doc.text(turkceKarakterCevir(`Toplam Kayıt: ${toplamKayit}`), 20, finalY + 17);

                doc.text(turkceKarakterCevir(`Toplam Gider: ${toplamGider.toFixed(2).replace('.', ',')} TL`), 110, finalY + 10, { align: "left" });
                doc.text(turkceKarakterCevir(`Kalan Tutar: ${kalanTutar.toFixed(2).replace('.', ',')} TL`), 110, finalY + 17, { align: "left" });

                // PDF'i kaydet
                doc.save("KategoriOzetRaporu.pdf");

            } catch (e) {
                console.error('PDF oluşturulurken hata oluştu:', e);
                showAlert('error', `❌ PDF oluşturulurken hata oluştu: ${e.message}`);
            }
        }

       
    </script>




    <style>
        .kategori-ozet-container {
            margin-top: 20px;
            font-family: "Segoe UI", Arial, sans-serif;
        }

            /* Yeni eklenen: Başlığı ortala */
            .kategori-ozet-container h3 {
                text-align: center;
                margin-bottom: 20px;
                color: #34495e;
                font-size: 20px;
                border-bottom: 2px solid #3498db;
                padding-bottom: 8px;
                width: 100%;
            }

        .table-wrapper {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        #dgvKategoriOzet {
            border-collapse: collapse;
            width: 100%;
            min-width: 600px;
        }

            #dgvKategoriOzet th, #dgvKategoriOzet td {
                padding: 10px 12px;
                border-bottom: 1px solid #ddd;
                text-align: left;
            }

            #dgvKategoriOzet th {
                background-color: #4a90e2;
                color: white;
                font-weight: bold;
                position: sticky;
                top: 0;
            }

        /* Butonlar için ortak stil */
        .pdf-button {
            background: linear-gradient(135deg, #4caf50, #81c784);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 46px;
            border: 2px solid transparent;
        }

            .pdf-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 10px rgba(0,0,0,0.15);
            }

            .pdf-button:active {
                transform: translateY(0);
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }

        /* Admin paneli butonu için farklı renk */
        #adminPanelBtn {
            background: linear-gradient(135deg, #2196F3, #64b5f6) !important;
        }

            #adminPanelBtn:hover {
                background: linear-gradient(135deg, #1976D2, #42a5f5) !important;
            }

        /* Buton container'ı */
        .kategori-ozet-container > div:last-child {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Mobil uyumluluk */
        @media (max-width: 600px) {
            .kategori-ozet-container > div:last-child {
                flex-direction: column;
                gap: 10px;
            }

            .pdf-button {
                width: 100%;
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
    <script>
        function loadKategoriOzet(kayitlar) {
            const tbody = document.querySelector("#dgvKategoriOzet tbody");
            tbody.innerHTML = "";

            let filtreliKayitlar = kayitlar || tumKayitlar;

            // Tarih filtresi
            if (tarihFiltresiAktif) {
                const ilkT = new Date(document.getElementById('ilkTarih').value);
                const sonT = new Date(document.getElementById('sonTarih').value);
                ilkT.setHours(0, 0, 0, 0);
                sonT.setHours(23, 59, 59, 999);

                filtreliKayitlar = filtreliKayitlar.filter(k => {
                    const kayitTarih = new Date(k.tarih);
                    return kayitTarih >= ilkT && kayitTarih <= sonT;
                });
            }

            // Gelir/Gider checkbox filtreleri
            const gelirCheck = document.getElementById('gelirCheck')?.checked;
            const giderCheck = document.getElementById('giderCheck')?.checked;

            filtreliKayitlar = filtreliKayitlar.filter(k => {
                if (!gelirCheck && !giderCheck) return true;
                return (gelirCheck && k.turu === 'Gelir') || (giderCheck && k.turu === 'Gider');
            });

            // Kategori arama filtresi
            const kategoriSearch = document.getElementById('kategoriSearch')?.value.toLowerCase() || '';
            filtreliKayitlar = filtreliKayitlar.filter(k => (k.kategoriAdi || '').toLowerCase().includes(kategoriSearch));

            // Kategoriye göre özetle
            const ozet = {};
            filtreliKayitlar.forEach(item => {
                const key = item.kategoriAdi || "Bilinmiyor";
                if (!ozet[key]) ozet[key] = { kayitSayisi: 0, toplamTutar: 0, tur: item.turu };
                ozet[key].kayitSayisi++;
                ozet[key].toplamTutar += item.tutar;
                ozet[key].tur = item.turu;
            });

            Object.keys(ozet).forEach(kategori => {
                const item = ozet[kategori];
                const tr = document.createElement("tr");
                tr.style.backgroundColor = item.tur.toLowerCase() === 'gelir' ? "#d4edda" : "#f8d7da";
                tr.innerHTML = `
                                                        <td>${kategori}</td>
                                                        <td>${item.kayitSayisi}</td>
                                                        <td>${item.toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                                        <td>${item.tur}</td>
                                                    `;
                tbody.appendChild(tr);
            });
        }

        // Filtreler değiştiğinde tekrar yükle
        ['gelirCheck', 'giderCheck', 'kategoriSearch', 'ilkTarih', 'sonTarih'].forEach(id => {
            document.getElementById(id)?.addEventListener(id === 'kategoriSearch' ? 'input' : 'change', () => loadKategoriOzet(tumKayitlar));
        });

        // Sayfa yüklendiğinde çağır
        // loadKategoriOzet(); // Bu satır kaldırıldı
    </script>


    <!-- Düzenleme Modal -->
    <style>
        /* Arka plan (modal dışı alanı karartır) */
        #editModal {
            display: none; /* Açılınca display: flex yapılır */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.45);
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: "Segoe UI", sans-serif;
        }

            /* Modal içeriği */
            #editModal .modal-content {
                background: #fff;
                border-radius: 16px;
                padding: 20px 25px;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.15);
                animation: slideDown 0.25s ease;
            }

            /* Başlık */
            #editModal h3 {
                margin-top: 0;
                text-align: center;
                color: #2b3a67;
                font-size: 1.3rem;
                border-bottom: 2px solid #eee;
                padding-bottom: 8px;
            }

            /* Form elemanları */
            #editModal select,
            #editModal input[type="text"],
            #editModal input[type="number"] {
                width: 100%;
                padding: 10px;
                margin-top: 10px;
                border-radius: 8px;
                border: 1px solid #ccc;
                font-size: 1rem;
                transition: border-color 0.2s, box-shadow 0.2s;
            }

                #editModal select:focus,
                #editModal input:focus {
                    outline: none;
                    border-color: #2b77e5;
                    box-shadow: 0 0 0 3px rgba(43, 119, 229, 0.15);
                }

            /* Butonlar */
            #editModal button {
                padding: 10px 16px;
                margin-top: 15px;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                cursor: pointer;
                width: 48%;
                transition: background 0.2s, transform 0.1s;
            }

                #editModal button:hover {
                    transform: scale(1.02);
                }

                /* Kaydet butonu */
                #editModal button:first-of-type {
                    background: #2b77e5;
                    color: white;
                }

                /* İptal butonu */
                #editModal button:last-of-type {
                    background: #e0e0e0;
                    color: #333;
                }

            /* Butonlar yan yana */
            #editModal .button-row {
                display: flex;
                justify-content: space-between;
            }

        /* Açılış animasyonu */
        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>

    <!-- Modal HTML -->
    <div id="editModal">
        <div class="modal-content">
            <h3>📋 Kayıt Düzenle</h3>
            <select id="editTuru" onchange="loadEditKategoriler(this.value)">
                <option value="">Tür Seçin</option>
                <option value="Gelir">Gelir</option>
                <option value="Gider">Gider</option>
            </select>
            <select id="editKategori">
                <option value="">Kategori Seçin</option>
            </select>
            <input type="text" id="editAciklama" placeholder="Açıklama">
            <input type="number" id="editTutar" placeholder="Tutar">
            <div class="button-row">
                <button onclick="saveEdit()">💾 Kaydet</button>
                <button onclick="closeEdit()">❌ İptal</button>
            </div>
        </div>
    </div>



    <script>
        let tumKayitlar = [], editId = null, kategorilerGlobal = [];
        let tarihFiltresiAktif = false; // Tarih filtresi aktif mi?

        // Çıkış fonksiyonu
        function cikisYap() {
            if (confirm('Çıkış yapmak istediğinize emin misiniz?')) {
                sessionStorage.removeItem('isLoggedIn');
                window.location.href = 'login.html';
            }
        }

        // Sayfa yüklendiğinde oturum kontrolü yap
        document.addEventListener("DOMContentLoaded", () => {
            // Oturum kontrolü
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (!isLoggedIn) {
                showAlert('warning', '⚠️ Lütfen giriş yapın!');
                window.location.href = 'login.html';
                return;
            }

            // Admin butonu görünürlüğü
            const token = sessionStorage.getItem('jwtToken');
            if (token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const decodedToken = JSON.parse(atob(base64));
                    console.log("JWT Token: ", token);
                    console.log("Decoded Token Role: ", decodedToken.role);
                    if (decodedToken.role === 'Admin') {
                        document.getElementById('adminPanelBtn').style.display = 'block'; // Admin ise butonu göster
                        console.log("Admin butonu gösterildi.");
                    }
                } catch (e) {
                    console.error("JWT token çözümlenirken hata oluştu:", e);
                    // Hata durumunda admin butonunu gizli tut
                }
            }
            else {
                console.log("JWT Token bulunamadı.");
            }

            const bugun = new Date();
            const birAyOncesi = new Date(); birAyOncesi.setMonth(bugun.getMonth() - 1);
            document.getElementById('ilkTarih').value = birAyOncesi.toISOString().split('T')[0];
            document.getElementById('sonTarih').value = bugun.toISOString().split('T')[0];
            loadKategoriler();
            loadGelirGider();
        });


        async function loadKategoriler() {
            try {
                const tur = document.getElementById("turu").value;
                const res = await fetch(`${apiBase}/Kategoriler`);
                const data = await res.json(); kategorilerGlobal = data;
                const kategoriSelect = document.getElementById("kategori");
                kategoriSelect.innerHTML = '<option value="">Kategori Seçin</option>';
                data.filter(k => !tur || k.tur === tur).forEach(kat => { const opt = document.createElement("option"); opt.value = kat.kategoriID; opt.textContent = kat.kategoriAdi; kategoriSelect.appendChild(opt); });
            } catch { showAlert('error', '❌ Kategoriler yüklenemedi!'); }
        }

        async function loadGelirGider() {
            const res = await fetch(`${apiBase}/GelirGider`);
            tumKayitlar = await res.json();
            const toplamGelir = tumKayitlar.filter(k => k.turu === 'Gelir').reduce((t, k) => t + k.tutar, 0);
            const toplamGider = tumKayitlar.filter(k => k.turu === 'Gider').reduce((t, k) => t + k.tutar, 0);
            document.getElementById("sabitTopGelir").textContent = formatCurrency(toplamGelir);
            document.getElementById("sabitTopGider").textContent = formatCurrency(toplamGider);
            document.getElementById("sabitNetTutar").textContent = formatCurrency(toplamGelir - toplamGider);
            renderTable(tumKayitlar);
            loadKategoriOzet(tumKayitlar);
        }

        function renderTable(kayitlar) {
            const tbody = document.getElementById("gelirGiderBody"); tbody.innerHTML = '';
            kayitlar.forEach(item => {
                const row = document.createElement("tr"); row.classList.add(item.turu === "Gelir" ? "gelir-row" : "gider-row");
                row.innerHTML = `<td>${item.turu}</td><td>${item.kategoriAdi ?? '-'}</td><td>${item.aciklama ?? ''}</td><td>${formatCurrency(item.tutar)}</td><td>${new Date(item.tarih).toLocaleDateString('tr-TR')}</td>
<td><button class="btn-duzenle" onclick="duzenle(${item.id})">✏️</button><button class="btn-sil" onclick="sil(${item.id})">🗑️</button></td>`;
                tbody.appendChild(row);
            });
            document.getElementById('toplamKayitSayisi').textContent = `Toplam Kayıt: ${kayitlar.length}`;
            loadToplamlar(kayitlar);
            loadKategoriOzet(kayitlar); // özet tabloyu filtreli kayıtlarla güncelle
        }

        function formatCurrency(amount) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2 }).format(amount); }

        async function addGelirGider() {
            const tur = document.getElementById("turu").value;
            const kategoriID = parseInt(document.getElementById("kategori").value);
            const aciklama = document.getElementById("aciklama").value.trim();
            const tutar = parseFloat(document.getElementById("tutar").value);
            if (!tur || !kategoriID || !tutar) return showAlert('warning', '⚠️ Eksik bilgi!');
            const kayit = { tarih: new Date().toISOString(), turu: tur, kategoriID, aciklama, tutar };
            const res = await fetch(`${apiBase}/GelirGider`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(kayit) });
            if (res.ok) { showAlert('success', '✅ Kayıt eklendi!'); document.getElementById("aciklama").value = ""; document.getElementById("tutar").value = ""; loadGelirGider(); }
            else { showAlert('error', '❌ Kayıt eklenirken hata oluştu!'); }
        }

        async function duzenle(id) {
            editId = id;
            const res = await fetch(`${apiBase}/GelirGider/${id}`); if (!res.ok) return showAlert('error', '❌ Kayıt bulunamadı.'); const data = await res.json();
            document.getElementById("editTuru").innerHTML = `<option value="Gelir">Gelir</option><option value="Gider">Gider</option>`; document.getElementById("editTuru").value = data.turu;
            document.getElementById("editAciklama").value = data.aciklama ?? ""; document.getElementById("editTutar").value = data.tutar;
            loadEditKategoriler(data.turu, data.kategoriID);
            document.getElementById('editModal').style.display = 'flex';
        }

        async function loadEditKategoriler(turu, selectedId) {
            const res = await fetch(`${apiBase}/Kategoriler`); const data = await res.json();
            const kategoriSelect = document.getElementById("editKategori"); kategoriSelect.innerHTML = '<option value="">Kategori Seçin</option>';
            data.filter(k => k.tur === turu).forEach(k => { const opt = document.createElement("option"); opt.value = k.kategoriID; opt.textContent = k.kategoriAdi; if (selectedId && k.kategoriID === selectedId) opt.selected = true; kategoriSelect.appendChild(opt); });
        }

        async function saveEdit() {
            const tur = document.getElementById("editTuru").value;
            const kategoriID = parseInt(document.getElementById("editKategori").value);
            const aciklama = document.getElementById("editAciklama").value.trim();
            const tutar = parseFloat(document.getElementById("editTutar").value);
            if (!tur || !kategoriID || !tutar) return showAlert('warning', '⚠️ Eksik bilgi!');
            const kayit = { tarih: new Date().toISOString(), turu: tur, kategoriID, aciklama, tutar };
            const res = await fetch(`${apiBase}/GelirGider/${editId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(kayit) });
            if (res.ok) { showAlert('success', '✅ Kayıt güncellendi!'); closeEdit(); loadGelirGider(); }
            else showAlert('error', '❌ Kayıt güncellenirken hata oluştu!');
        }

        async function sil(id) {
            if (!confirm("Bu kaydı silmek istediğinize emin misiniz?")) return;
            const res = await fetch(`${apiBase}/GelirGider/${id}`, { method: "DELETE" });
            if (res.ok) {
                showAlert('success', '🗑️ Kayıt silindi!');
                loadGelirGider();
            } else {
                showAlert('error', '❌ Kayıt silinirken hata oluştu!');
            }
        }

        function closeEdit() { document.getElementById('editModal').style.display = 'none'; }

        function loadToplamlar(kayitlar) {
            const toplamGelir = kayitlar.filter(k => k.turu === 'Gelir').reduce((t, k) => t + k.tutar, 0);
            const toplamGider = kayitlar.filter(k => k.turu === 'Gider').reduce((t, k) => t + k.tutar, 0);
            document.getElementById("topGelir").textContent = formatCurrency(toplamGelir);
            document.getElementById("topGider").textContent = formatCurrency(toplamGider);
            document.getElementById("netTutar").textContent = formatCurrency(toplamGelir - toplamGider);
        }

        function filterByDate() {
            tarihFiltresiAktif = true; // Tarih filtresini aktif et
            filterByTypeAndDate();
            loadKategoriOzet(tumKayitlar);
        }

        function handleTypeCheckbox(type) {
            const g = document.getElementById('gelirCheck'), d = document.getElementById('giderCheck');
            if (type === 'gelir') {
                if (g.checked) d.checked = false;
            } else if (type === 'gider') {
                if (d.checked) g.checked = false;
            }
            // Tarih filtresi aktif ise onu kullan, değilse sadece tür ve kategori kullan
            if (tarihFiltresiAktif) {
                filterByTypeAndDate();
            } else {
                filterByTypeAndCategory();
                loadKategoriOzet(tumKayitlar);
            }
        }

        function filterByTypeAndDate() {
            const ilkT = new Date(document.getElementById('ilkTarih').value); ilkT.setHours(0, 0, 0, 0);
            const sonT = new Date(document.getElementById('sonTarih').value); sonT.setHours(23, 59, 59, 999);
            const gelirCheck = document.getElementById('gelirCheck').checked;
            const giderCheck = document.getElementById('giderCheck').checked;
            const kategoriSearch = document.getElementById('kategoriSearch').value.toLowerCase();
            const filtreli = tumKayitlar.filter(k => {
                const kayitT = new Date(k.tarih); kayitT.setHours(0, 0, 0, 0);
                const tarihKontrol = kayitT >= ilkT && kayitT <= sonT;
                const turKontrol = (!gelirCheck && !giderCheck) || (gelirCheck && k.turu === 'Gelir') || (giderCheck && k.turu === 'Gider');
                const kategoriEsles = k.kategoriAdi.toLowerCase().includes(kategoriSearch);
                return tarihKontrol && turKontrol && kategoriEsles;
            });

            renderTable(filtreli);
            loadKategoriOzet(filtreli); // özet tabloyu filtreli kayıtlarla güncelle
        }

        function clearFilters() {
            tarihFiltresiAktif = false; // Tarih filtresini devre dışı bırak
            document.getElementById('kategoriSearch').value = '';
            document.getElementById('gelirCheck').checked = false;
            document.getElementById('giderCheck').checked = false;
            const bugun = new Date();
            const birAy = new Date();
            birAy.setMonth(bugun.getMonth() - 1);
            document.getElementById('ilkTarih').value = birAy.toISOString().split('T')[0];
            document.getElementById('sonTarih').value = bugun.toISOString().split('T')[0];
            renderTable(tumKayitlar);
            loadToplamlar(tumKayitlar);
            loadKategoriOzet(tumKayitlar);
        }

        function handleKategoriSearch() {
            // Tarih filtresi aktif ise onu kullan, değilse sadece tür ve kategori kullan
            if (tarihFiltresiAktif) {
                filterByTypeAndDate();
            } else {
                filterByTypeAndCategory();
            }
        }

        function filterByTypeAndCategory() {
            const gelirCheck = document.getElementById('gelirCheck').checked;
            const giderCheck = document.getElementById('giderCheck').checked;
            const kategoriSearch = document.getElementById('kategoriSearch').value.toLowerCase();
            const filtreli = tumKayitlar.filter(k => {
                const turKontrol = (!gelirCheck && !giderCheck) || (gelirCheck && k.turu === 'Gelir') || (giderCheck && k.turu === 'Gider');
                const kategoriEsles = k.kategoriAdi.toLowerCase().includes(kategoriSearch);
                return turKontrol && kategoriEsles;
            });
            renderTable(filtreli);
            loadKategoriOzet(filtreli);
        }


       

        async function exportFilteredToExcel() {
            if (typeof ExcelJS === 'undefined') {
                showAlert('error', '❌ ExcelJS yüklü değil');
                return;
            }

            const tbody = document.getElementById("gelirGiderBody");
            if (!tbody) { showAlert('error', 'Tablo bulunamadı'); return; }

            const domRows = Array.from(tbody.querySelectorAll('tr'))
                .filter(r => r.style.display !== 'none'); // sadece görünen satırlar

            const filtrelenmisKayitlar = [];

            domRows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 5) return;

                const turu = cells[0]?.textContent.trim();
                const kategori = cells[1]?.textContent.trim();
                const aciklama = cells[2]?.textContent.trim();
                const tutarText = cells[3]?.textContent.trim();
                const tarih = cells[4]?.textContent.trim();

                // Tutarı parse et
                const tutarNum = parseFloat(tutarText.replace(/[^\d.,]/g, '').replace(/\./g, '').replace(',', '.'));

                // PDF mantığıyla: sadece geçerli tutarları al
                if (!isNaN(tutarNum) && tutarNum > 0) {
                    filtrelenmisKayitlar.push({
                        sira: filtrelenmisKayitlar.length + 1, // sıra numarası
                        turu,
                        kategoriAdi: kategori || '-',
                        aciklama: aciklama || '',
                        tutar: tutarNum,
                        tarih: tarih || ''
                    });
                }
            });

            if (filtrelenmisKayitlar.length === 0) {
                showAlert('warning', '⚠️ Aktarılacak veri yok');
                return;
            }

            // --- Excel oluştur ---
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('Gelir Gider');

            ws.columns = [
                { header: 'Sıra', key: 'sira', width: 10 },
                { header: 'Tür', key: 'turu', width: 15 },
                { header: 'Kategori', key: 'kategoriAdi', width: 25 },
                { header: 'Açıklama', key: 'aciklama', width: 30 },
                { header: 'Tutar', key: 'tutar', width: 15 },
                { header: 'Tarih', key: 'tarih', width: 15 }
            ];

            filtrelenmisKayitlar.forEach(item => ws.addRow(item));

            ws.getColumn(5).numFmt = '#,##0.00 ₺';
            ws.getColumn(5).alignment = { horizontal: 'right' };

            const buffer = await wb.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'GelirGiderRaporu.xlsx';
            link.click();
        }



    </script>

    <script>
        // Türkçe karakterleri ASCII'ye çeviren fonksiyon
        function turkceKarakterCevir(text) {
            if (!text) return '';
            const charMap = {
                'ç': 'c', 'Ç': 'C',
                'ğ': 'g', 'Ğ': 'G',
                'ı': 'i', 'İ': 'I',
                'ö': 'o', 'Ö': 'O',
                'ş': 's', 'Ş': 'S',
                'ü': 'u', 'Ü': 'U'
            };
            return text.split('').map(char => charMap[char] || char).join('');
        }

        async function exportToPDF() {
            console.log('PDF oluşturma başladı.');
            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    showAlert('error', '❌ jsPDF kütüphanesi yüklenemedi!');
                    return;
                }

                // Mevcut filtrelenmiş kayıtları al
                let filtrelenmisKayitlar = [];

                // Tablodan veriyi oku
                const tbody = document.getElementById("gelirGiderBody");
                const domRows = Array.from(tbody.querySelectorAll('tr'));

                domRows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 6) return;

                    const turuCell = cells[0];
                    const kategoriCell = cells[1];
                    const aciklamaCell = cells[2];
                    const tutarCell = cells[3];
                    const tarihCell = cells[4];

                    if (!turuCell || !tutarCell) return;

                    const turu = turuCell.textContent.trim();
                    const kategori = kategoriCell.textContent.trim();
                    const aciklama = aciklamaCell.textContent.trim();
                    const tutarText = tutarCell.textContent.trim();
                    const tarih = tarihCell.textContent.trim();

                    // Tutarı parse et
                    const tutarNum = parseFloat(tutarText.replace(/[^\d.,]/g, '').replace(/\./g, '').replace(',', '.'));

                    if (!isNaN(tutarNum) && tutarNum > 0) {
                        filtrelenmisKayitlar.push({
                            sira: index + 1,
                            turu: turkceKarakterCevir(turu),
                            kategoriAdi: turkceKarakterCevir(kategori),
                            aciklama: turkceKarakterCevir(aciklama),
                            tutar: tutarNum,
                            tarih: turkceKarakterCevir(tarih)
                        });
                    }
                });

                if (filtrelenmisKayitlar.length === 0) {
                    showAlert('warning', '⚠️ Aktarılacak veri yok!');
                    return;
                }

                const doc = new jsPDF("p", "mm", "a4");

                // --- ÜST BİLGİ BLOĞU ---
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(0, 102, 204);
                doc.text(turkceKarakterCevir("GELİR GİDER RAPORU"), 105, 20, { align: "center" });

                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.setTextColor(40, 40, 40);
                doc.text(turkceKarakterCevir("SALASH CANLI MEZAT"), 105, 28, { align: "center" });

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(80, 80, 80);
                doc.text(turkceKarakterCevir("Hocacihan Hanaybaşı, Alemdar Cd. No:107, 42080 Selçuklu/Konya"), 105, 34, { align: "center" });
                doc.text("Tel: 0507 477 12 50", 105, 40, { align: "center" });

                doc.setFont("helvetica", "normal");
                doc.setFontSize(8);
                doc.setTextColor(50, 50, 50);
                doc.text(`Tarih: ${new Date().toLocaleString("tr-TR")}`, 200, 46, { align: "right" });

                // --- TABLO ---
                const headers = [turkceKarakterCevir('Sıra'), turkceKarakterCevir('Tür'), turkceKarakterCevir('Kategori'), turkceKarakterCevir('Açıklama'), 'Tutar (TL)', turkceKarakterCevir('Tarih')];
                const tableRows = filtrelenmisKayitlar.map(item => [
                    item.sira,
                    item.turu,
                    item.kategoriAdi,
                    item.aciklama,
                    item.tutar.toFixed(2).replace('.', ',') + ' TL',
                    item.tarih
                ]);

                // Tablo oluştur
                doc.autoTable({
                    startY: 52,
                    head: [headers],
                    body: tableRows,
                    theme: 'grid',
                    styles: {
                        font: "helvetica",
                        fontSize: 9,
                        cellPadding: 3,
                        valign: 'middle',
                        lineWidth: 0.1,
                        lineColor: [100, 100, 100]
                    },
                    headStyles: {
                        fillColor: [120, 160, 220],
                        textColor: [255, 255, 255],
                        halign: 'center',
                        lineWidth: 0.1,
                        lineColor: [80, 80, 80]
                    },
                    didParseCell: function (data) {
                        if (data.section === 'body') {
                            const tur = data.row.raw[1];
                            if (tur === 'Gelir') {
                                data.cell.styles.fillColor = [220, 255, 220];
                            } else if (tur === 'Gider') {
                                data.cell.styles.fillColor = [255, 230, 230];
                            }
                        }
                    },
                    columnStyles: {
                        0: { cellWidth: 15, halign: 'center' },
                        1: { cellWidth: 25, halign: 'center' },
                        2: { cellWidth: 35, halign: 'left' },
                        3: { cellWidth: 45, halign: 'left' },
                        4: { cellWidth: 30, halign: 'right' },
                        5: { cellWidth: 30, halign: 'center' }
                    },
                    tableWidth: 'wrap'
                });

                // --- ALT TOPLAM ---
                const toplamGelir = filtrelenmisKayitlar.filter(x => x.turu === 'Gelir').reduce((a, b) => a + b.tutar, 0);
                const toplamGider = filtrelenmisKayitlar.filter(x => x.turu === 'Gider').reduce((a, b) => a + b.tutar, 0);
                const netTutar = toplamGelir - toplamGider;
                const toplamKayit = filtrelenmisKayitlar.length;

                const finalY = doc.lastAutoTable?.finalY || 100;

                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.setTextColor(30, 30, 30);

                doc.text(turkceKarakterCevir(`Toplam Gelir: ${toplamGelir.toFixed(2).replace('.', ',')} TL`), 20, finalY + 10);
                doc.text(turkceKarakterCevir(`Toplam Kayıt: ${toplamKayit}`), 20, finalY + 17);

                doc.text(turkceKarakterCevir(`Toplam Gider: ${toplamGider.toFixed(2).replace('.', ',')} TL`), 110, finalY + 10, { align: "left" });
                doc.text(turkceKarakterCevir(`Kalan Tutar: ${netTutar.toFixed(2).replace('.', ',')} TL`), 110, finalY + 17, { align: "left" });

                doc.save("GelirGiderRaporu.pdf");

            } catch (e) {
                console.error('PDF olusturulurken hata olustu:', e);
                showAlert('error', `❌ PDF oluşturulurken hata oluştu: ${e.message}`);
            }
        }
    </script>
</body>

<script>
    // Sayfa yüklendiğinde hoşgeldin mesajını göster
    document.addEventListener("DOMContentLoaded", function () {
        const welcomeMessageContainer = document.getElementById('welcomeMessageContainer');
        const token = sessionStorage.getItem('jwtToken');
        const showWelcome = sessionStorage.getItem('showWelcomeMessage'); // Yeni eklenen satır

        // Hoşgeldin mesajı sadece giriş yapıldıktan sonra gösterilecekse
        if (token && showWelcome === 'true') {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const decodedToken = JSON.parse(atob(base64));
                const displayName = decodedToken.displayName; // JWT'den displayName'i al

                if (displayName) {
                    welcomeMessageContainer.innerHTML = `✅ Hoşgeldin ${displayName}!`;
                    welcomeMessageContainer.style.display = 'flex'; // Mesajı görünür yap

                    // 2 saniye sonra mesajı kaldır
                    setTimeout(() => {
                        welcomeMessageContainer.classList.add('hide'); // Kaybolma animasyonunu tetikle
                        setTimeout(() => {
                            welcomeMessageContainer.remove(); // Elementi tamamen kaldır
                        }, 500); // CSS animasyon süresi ile eşleşmeli
                    }, 2000);
                }
            } catch (e) {
                console.error("JWT token çözümlenirken veya hoşgeldin mesajı oluşturulurken hata oluştu:", e);
            } finally {
                // Mesajı gösterdikten sonra bayrağı kaldır
                sessionStorage.removeItem('showWelcomeMessage');
            }
        }

        // Eski loginMessage kontrolünü kaldır (zaten kaldırılmıştı)
        sessionStorage.removeItem('loginMessage');
    });
</script>
</html>
